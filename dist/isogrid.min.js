/*
 IsoGrid 2014-10-07 
*/
var isoGridModule=angular.module("isoGrid",[]).directive("bindHtmlCompile",function(a,b){return{restrict:"A",link:function(c,d,e){c.$watch(e.content,function(){d.html(b(e.content)(c)),a(d.contents())(c)},!0)}}}).directive("isogrid",["PositionService","FilterService","OrderService","$timeout",function(a,b,c,d){return{restrict:"E",scope:{items:"=items",rankers:"=rankers",filters:"=filters"},template:'<div id="item-{{it.id}}" class="item" ng-repeat="it in items" bind-html-compile content="it.template"></div>',link:function(e){d(function(){e.$watch("items",function(){d(function(){a.apply(e.items)})},!0),e.$watch("filters",function(){b.apply(e.items,e.filters),a.apply(e.items)}),e.$watch("rankers",function(){c.apply(e.items,e.rankers),a.apply(e.items)})})}}}]);isoGridModule.factory("FilterService",function(){var a=["=","<",">","<=",">=","!=","in","not in","contains"],b=function(b,c){if("function"==typeof c)return c(b);if(c.length<2)throw"Incorrect statement";var d=c[0],e=c[1],f=c[2];if(!e in a)throw"Incorrect statement comparator";if(!b[d])return!1;switch(e){case"=":return b[d]==f;case"<":return b[d]<f;case"<=":return b[d]<=f;case">":return b[d]>f;case">=":return b[d]>=f;case"!=":return b[d]!=f;case"in":return b[d]in f;case"not in":return!b[d]in f;case"contains":if(!b[d]instanceof Array)throw"contains statement has to be applied on array";return b[d].indexOf(f)>-1}},c=function(a,c){for(j in c)if(b(a,c[j]))return!0;return!1},d=function(a,b){for(i in b)if(!c(a,b[i]))return!1;return!0};return{apply:function(a,b){for(i in a)a[i].showing=d(a[i],b);return a}}}),isoGridModule.factory("OrderService",function(){return{apply:function(a,b){var c=0,d=function(a,e){var f=b[c][0],g=b[c][1];if("function"==typeof f)var h=f(a),i=f(e);else{if(f in a||f in e){if(!f in a)return"asc"==g?-1:1;if(!f in e)return"asc"==g?1:-1}else var h=0,i=0;var h=a[f],i=e[f]}return h>i?"asc"==g?1:-1:h>i?"asc"==g?-1:1:(++c,b.length>c?d(a,e):0)},e=function(a,b){c=0;var e=d(a,b);return e};return b&&a.sort(e),a}}}),isoGridModule.factory("PositionService",function(){function a(a){for(i=0;i<a.length;++i)element=document.getElementById("item-"+a[i].id),a[i].h=element.offsetHeight+parseInt(window.getComputedStyle(element).marginTop);return a}function b(a){for(columns=[],i=0;a>i;++i)columns.push([]);return columns}function c(a){columnsHeights=[];for(i in a){var b=0;for(j in a[i])b+=a[i][j].h;columnsHeights.push(b)}return columnsHeights}function d(a,b){var c=a.width;if(c>b.length)throw Error("Item too large");var d=0,e=0;for(i=0;i<=b.length-c;++i){var f=i,g=i+c,h=Math.max.apply(Math,b.slice(f,g));(0==i||e>h)&&(e=h,d=i)}var j=[];for(i=d;d+c>i;++i)j.push(i);return{columns:j,y:e}}function e(a,b,c){for(j in b)a[b[j]].push(c)}function f(a){for(i=0;i<a.length;++i)element=document.getElementById("item-"+a[i].id),element.style.position="absolute",element.style.left=a[i].x+"px",element.style.top=a[i].y+"px"}return{apply:function(g){nbColumns=3,colSize=415,columns=b(nbColumns);for(k in g)"showing"in g[k]&&(element=document.getElementById("item-"+g[k].id),element.style.display=g[k].showing?"":"None");g=a(g);for(k in g)if(!("showing"in g[k])||g[k].showing){var h=c(columns),i=d(g[k],h),j=i.columns;e(columns,j,g[k]),g[k].x=j[0]*colSize,g[k].y=i.y}f(g)}}});