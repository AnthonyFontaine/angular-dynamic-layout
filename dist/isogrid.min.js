/*
 IsoGrid 2015-01-02 
*/
var isoGridModule=angular.module("isoGrid",["ngAnimate"]).filter("customFilter",["FilterService",function(a){return function(b,c){return c?a.applyFilters(b,c):b}}]).filter("customRanker",["RankerService",function(a){return function(b,c){return c?a.applyRankers(b,c):b}}]).filter("as",["$parse",function(a){return function(b,c,d){return a(d).assign(c,b)}}]).directive("layoutOnLoad",["$rootScope",function(a){return{restrict:"A",link:function(b,c){c.bind("load error",function(){a.$broadcast("layout")})}}}]).directive("isogrid",["$timeout","$window","$q","$animate","PositionService",function(a,b,c,d,e){return{restrict:"A",scope:{items:"=items",rankers:"=rankers",filters:"=filters"},template:'<div                                                           class="isogrid-item-parent"                                 ng-repeat="it in items |                                               customFilter: filters |                                     customRanker:rankers |                                      as:this:\'filteredItems\'"                       ng-include="it.template"                                ></div>',link:function(d,f){d.templatesToLoad=0;var g=function(){return e.layout(f[0].offsetWidth)},h=function(){var b=c.defer();return a(function(){0===d.templatesToLoad&&b.resolve()}),d.$watch("templatesToLoad",function(a,c){a!==c&&0===d.templatesToLoad&&b.resolve()}),b.promise};d.$on("$includeContentRequested",function(){d.templatesToLoad++}),d.$on("$includeContentLoaded",function(){d.templatesToLoad--}),d.externalScope=function(){return d.$parent},d.$watch("filteredItems",function(a,b){angular.equals(a,b)||h().then(function(){g()})},!0),angular.element(b).bind("resize",function(){d.$apply(function(){g()})}),d.$on("layout",function(a,b){g().then(function(){"function"==typeof b&&b()})}),h().then(function(){g()})}}}]);isoGridModule.factory("FilterService",function(){var a=function(a,b){if("function"==typeof b)return b(a);var c=3;if(b.length<c)throw"Incorrect statement";var d=b[0],e=b[1],f=b[2];if(!a[d])return!1;switch(e){case"=":return a[d]==f;case"<":return a[d]<f;case"<=":return a[d]<=f;case">":return a[d]>f;case">=":return a[d]>=f;case"!=":return a[d]!=f;case"in":return a[d]in f;case"not in":return!(a[d]in f);case"contains":if(!(a[d]instanceof Array))throw"contains statement has to be applied on array";return a[d].indexOf(f)>-1;default:throw"Incorrect statement comparator: "+e}},b=function(b,c){for(var d in c)if(a(b,c[d]))return!0;return!1},c=function(a,c){for(var d in c)if(!b(a,c[d]))return!1;return!0};return{applyFilters:function(a,b){var d=[];for(var e in a)c(a[e],b)&&d.push(a[e]);return d}}}),isoGridModule.factory("PositionService",["$window","$animate","$timeout","$q",function(a,b,c,d){var e={},f=[],g=[],h=function(a){columns=[];for(var b=0;a>b;++b)columns.push([]);return columns},j=function(a){columnsHeights=[];for(var b in a){var c;if(a[b].length){var d=a[b][a[b].length-1];c=d.y+d.height}else c=0;columnsHeights.push(c)}return columnsHeights},k=function(a,b,c){if(a.columnSpan>b.length)throw Error("Item too large");for(var d=0,e=0,f=0;f<=b.length-a.columnSpan;++f){var g=f,h=f+a.columnSpan,i=Math.max.apply(Math,b.slice(g,h));(0===f||e>i)&&(e=i,d=f)}var j=[];for(f=d;f<d+a.columnSpan;++f)j.push(f);var k={x:j[0]*c,y:e};return{columns:j,position:k}},l=function(a,b){for(i=0;i<f.length;++i){var c=j(a),d=k(f[i],c,b);for(var e in d.columns)a[d.columns[e]].push(f[i]);f[i].x=d.position.x,f[i].y=d.position.y}},m=function(){var a;for(i=0;i<f.length;++i)(!a||f[i].width<a)&&(a=f[i].width);return a},n=function(a){for(i=0;i<f.length;++i)f[i].columnSpan=Math.ceil(f[i].width/a)};return{getItemsDimensionFromDOM:function(){for(g=document.querySelectorAll(".isogrid-item-parent:not(.ng-leave)"),f=[],i=0;i<g.length;++i)f.push({height:g[i].offsetHeight+parseInt(a.getComputedStyle(g[i]).marginTop),width:g[i].children[0].offsetWidth+parseInt(a.getComputedStyle(g[i].children[0]).marginLeft)});return f},applyToDOM:function(a){var h=d.defer(),j=function(a,c){var d=b.addClass(a,"move-items-animation",{from:{position:"absolute"},to:{left:f[c].x+"px",top:f[c].y+"px"}});return d.then(function(){a.classList.remove("move-items-animation"),delete e[c]}),d},k=function(){for(i=0;i<f.length;++i)e[i]=j(g[i],i);d.all(e).then(function(){h.resolve()})};if(angular.equals(a,f))return h.resolve(),h.promise;if(Object.keys(e).length){for(var l in e)b.cancel(e[l]),delete e[l];c(function(){k(h)})}else k(h);return h.promise},layout:function(a){var b=angular.copy(f);f=this.getItemsDimensionFromDOM();var c=m(),d=Math.floor(a/c),e=h(d);return n(c),l(e,c),this.applyToDOM(b)}}}]),isoGridModule.factory("RankerService",function(){return{applyRankers:function(a,b){var c=0,d=function(a,e){var f,g,h=b[c][0],i=b[c][1];if("function"==typeof h)f=h(a),g=h(e);else{if(h in a||h in e){if(!(h in a))return"asc"==i?-1:1;if(!(h in e))return"asc"==i?1:-1}else f=0,g=0;f=a[h],g=e[h]}if(typeof f==typeof g)if("string"==typeof f){var j=f.localeCompare(g);if(1==j)return"asc"==i?1:-1;if(-1==j)return"asc"==i?-1:1}else{if(f>g)return"asc"==i?1:-1;if(g>f)return"asc"==i?-1:1}return++c,b.length>c?d(a,e):0},e=function(a,b){c=0;var e=d(a,b);return e};return b&&a.sort(e),a}}});