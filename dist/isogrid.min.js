/*
 IsoGrid 2014-12-17 
*/
var isoGridModule=angular.module("isoGrid",["ngAnimate"]).filter("customFilter",["FilterService",function(a){return function(b,c){return c?a.apply(b,c):b}}]).filter("customRanker",["OrderService",function(a){return function(b,c){return c?a.apply(b,c):b}}]).filter("as",["$parse",function(a){return function(b,c,d){return a(d).assign(c,b)}}]).directive("img",["$rootScope",function(a){return{restrict:"E",link:function(b,c){c.bind("load",function(){a.$broadcast("layout")}),c.bind("error",function(){a.$broadcast("layout")})}}}]).directive("isogrid",["PositionService","$timeout","$window","$q","$animate",function(a,b,c,d){return{restrict:"A",scope:{items:"=items",rankers:"=rankers",filters:"=filters"},template:'<div                                                           class="isogrid-item-parent"                                 ng-repeat="it in items |                                               customFilter: filters |                                     customRanker:rankers |                                      as:this:\'filteredItems\'"                       ng-include="it.template"                                ></div>',link:function(e,f){var g=function(){return a.apply(f[0].offsetWidth,e.filteredItems.length)},h=function(){var a=d.defer();return b(function(){0===e.toLoad&&a.resolve()}),e.$watch("toLoad",function(b,c){b!==c&&0===e.toLoad&&a.resolve()}),a.promise};e.toLoad=0,e.$on("$includeContentRequested",function(){e.toLoad++}),e.$on("$includeContentLoaded",function(){e.toLoad--}),e.externalScope=function(){return e.$parent},e.$watch("filteredItems",function(a,b){angular.equals(a,b)||h().then(function(){g()})},!0),angular.element(c).bind("resize",function(){e.$apply(function(){g()})}),e.$on("layout",function(a,c){b(function(){g().then(function(){"function"==typeof c&&c()})})}),h().then(function(){g()})}}}]);isoGridModule.factory("FilterService",function(){var a=["=","<",">","<=",">=","!=","in","not in","contains"],b=function(b,c){if("function"==typeof c)return c(b);if(c.length<2)throw"Incorrect statement";var d=c[0],e=c[1],f=c[2];if(-1===a.indexOf(e))throw"Incorrect statement comparator: "+e;if(!b[d])return!1;switch(e){case"=":return b[d]==f;case"<":return b[d]<f;case"<=":return b[d]<=f;case">":return b[d]>f;case">=":return b[d]>=f;case"!=":return b[d]!=f;case"in":return b[d]in f;case"not in":return!(b[d]in f);case"contains":if(!(b[d]instanceof Array))throw"contains statement has to be applied on array";return b[d].indexOf(f)>-1}},c=function(a,c){for(var d in c)if(b(a,c[d]))return!0;return!1},d=function(a,b){for(var d in b)if(!c(a,b[d]))return!1;return!0};return{apply:function(a,b){var c=[];for(var e in a)d(a[e],b)&&c.push(a[e]);return c}}}),isoGridModule.factory("OrderService",function(){return{apply:function(a,b){var c=0,d=function(a,e){var f,g,h=b[c][0],i=b[c][1];if("function"==typeof h)f=h(a),g=h(e);else{if(h in a||h in e){if(!(h in a))return"asc"==i?-1:1;if(!(h in e))return"asc"==i?1:-1}else f=0,g=0;f=a[h],g=e[h]}if(typeof f==typeof g)if("string"==typeof f){var j=f.localeCompare(g);if(1==j)return"asc"==i?1:-1;if(-1==j)return"asc"==i?-1:1}else{if(f>g)return"asc"==i?1:-1;if(g>f)return"asc"==i?-1:1}return++c,b.length>c?d(a,e):0},e=function(a,b){c=0;var e=d(a,b);return e};return b&&a.sort(e),a}}}),isoGridModule.factory("PositionService",["$window","$animate","$timeout","$q",function(a,b,c,d){function e(a){columns=[];for(var b=0;a>b;++b)columns.push([]);return columns}function f(a){columnsHeights=[];for(var b in a){var c;if(a[b].length){var d=a[b][a[b].length-1];c=d.y+d.height}else c=0;columnsHeights.push(c)}return columnsHeights}function g(a,b,c){if(a.columnSpan>b.length)throw Error("Item too large");for(var d=0,e=0,f=0;f<=b.length-a.columnSpan;++f){var g=f,h=f+a.columnSpan,i=Math.max.apply(Math,b.slice(g,h));(0===f||e>i)&&(e=i,d=f)}var j=[];for(f=d;f<d+a.columnSpan;++f)j.push(f);return{columns:j,position:{x:j[0]*c,y:e}}}function h(a,b){for(i=0;i<m.length;++i){var c=f(a),d=g(m[i],c,b);for(var e in d.columns)a[d.columns[e]].push(m[i]);m[i].x=d.position.x,m[i].y=d.position.y}}function j(){var a;for(i=0;i<m.length;++i)(!a||m[i].width<a)&&(a=m[i].width);return a}function k(a){for(i=0;i<m.length;++i)m[i].columnSpan=Math.ceil(m[i].width/a)}var l={},m=[],n=[];return{getItemsDimensionFromDOM:function(){for(n=document.querySelectorAll(".isogrid-item-parent:not(.ng-leave)"),m=[],i=0;i<n.length;++i)m.push({height:n[i].offsetHeight+parseInt(a.getComputedStyle(n[i]).marginTop),width:n[i].children[0].offsetWidth+parseInt(a.getComputedStyle(n[i].children[0]).marginLeft)});return m},applyToDOM:function(a){var e=function(a,c){var d=b.addClass(a,"move-items-animation",{from:{position:"absolute"},to:{left:m[c].x+"px",top:m[c].y+"px"}});return d.then(function(){a.classList.remove("move-items-animation"),delete l[c]}),d},f=function(){for(i=0;i<m.length;++i)l[i]=e(n[i],i);d.all(l).then(function(){g.resolve()})},g=d.defer();if(angular.equals(a,m))return g.resolve(),g.promise;if(Object.keys(l).length){for(var h in l)b.cancel(l[h]),delete l[h];c(function(){f(g)})}else f(g);return g.promise},apply:function(a){var b=angular.copy(m);m=this.getItemsDimensionFromDOM();var c=j(),d=Math.floor(a/c),f=e(d);return k(c),h(f,c),this.applyToDOM(b)}}}]);