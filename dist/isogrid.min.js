/*
 IsoGrid 2014-10-20 
*/
var isoGridModule=angular.module("isoGrid",[]).directive("bindHtmlCompile",["$compile","$parse",function(a,b){return{restrict:"A",link:function(c,d,e){c.$watch(e.content,function(){d.html(b(e.content)(c)),a(d.contents())(c)},!0)}}}]).directive("isogrid",["PositionService","FilterService","OrderService","$timeout",function(a,b,c,d){return{restrict:"E",scope:{items:"=items",rankers:"=rankers",filters:"=filters"},template:'<div id="item-{{it.id}}" class="item" ng-repeat="it in items" bind-html-compile content="it.template"></div>',link:function(e){d(function(){e.$watch("items",function(){d(function(){a.apply(e.items)})},!0),e.$watch("filters",function(){b.apply(e.items,e.filters),a.apply(e.items)}),e.$watch("rankers",function(){c.apply(e.items,e.rankers),a.apply(e.items)})})}}}]);isoGridModule.factory("FilterService",function(){var a=["=","<",">","<=",">=","!=","in","not in","contains"],b=function(b,c){if("function"==typeof c)return c(b);if(c.length<2)throw"Incorrect statement";var d=c[0],e=c[1],f=c[2];if(-1===a.indexOf(e))throw"Incorrect statement comparator: "+e;if(!b[d])return!1;switch(e){case"=":return b[d]==f;case"<":return b[d]<f;case"<=":return b[d]<=f;case">":return b[d]>f;case">=":return b[d]>=f;case"!=":return b[d]!=f;case"in":return b[d]in f;case"not in":return!(b[d]in f);case"contains":if(!(b[d]instanceof Array))throw"contains statement has to be applied on array";return b[d].indexOf(f)>-1}},c=function(a,c){for(var d in c)if(b(a,c[d]))return!0;return!1},d=function(a,b){for(var d in b)if(!c(a,b[d]))return!1;return!0};return{apply:function(a,b){for(var c in a)a[c].showing=d(a[c],b);return a}}}),isoGridModule.factory("OrderService",function(){return{apply:function(a,b){var c=0,d=function(a,e){var f,g,h=b[c][0],i=b[c][1];if("function"==typeof h)f=h(a),g=h(e);else{if(h in a||h in e){if(!(h in a))return"asc"==i?-1:1;if(!(h in e))return"asc"==i?1:-1}else f=0,g=0;f=a[h],g=e[h]}if(typeof f==typeof g)if("string"==typeof f){var j=f.localeCompare(g);if(1==j)return"asc"==i?1:-1;if(-1==j)return"asc"==i?-1:1}else{if(f>g)return"asc"==i?1:-1;if(g>f)return"asc"==i?-1:1}return++c,b.length>c?d(a,e):0},e=function(a,b){c=0;var e=d(a,b);return e};return b&&a.sort(e),a}}}),isoGridModule.factory("PositionService",["$window",function(a){function b(a){return!("showing"in a)||a.showing}function c(a){columns=[];for(var b=0;a>b;++b)columns.push([]);return columns}function d(a){columnsHeights=[];for(var b in a){var c=0;for(var d in a[b])c+=a[b][d].height;columnsHeights.push(c)}return columnsHeights}function e(a,b,c){var d=a.width;if(d>b.length)throw Error("Item too large");for(var e=0,f=0,g=0;g<=b.length-d;++g){var h=g,i=g+d,j=Math.max.apply(Math,b.slice(h,i));(0===g||f>j)&&(f=j,e=g)}var k=[];for(g=e;e+d>g;++g)k.push(g);return{columns:k,position:{x:k[0]*c,y:f}}}function f(a,b,c){for(var d in b)a[b[d]].push(c)}function g(a,b){var c=d(b),g=e(a,c);f(b,g.columns,a),a.x=g.position.x,a.y=g.position.y}function h(a){return document.getElementById("item-"+a.id)}function j(a){for(var b in a)"showing"in a[b]&&(a[b].showing?l(a[b]):k(a[b]))}function k(a){element=h(a),element.style.display="None"}function l(a){element=h(a),element.style.display=""}function m(a){for(i=0;i<a.length;++i)element=h(a[i]),element.style.position="absolute",element.style.left=a[i].x+"px",element.style.top=a[i].y+"px"}return{setItemHeightsFromDOM:function(b){for(i=0;i<b.length;++i)element=h(b[i]),b[i].height=element.offsetHeight+parseInt(a.getComputedStyle(element).marginTop)},applyToDOM:function(a){j(a),m(a)},apply:function(a){nbColumns=3,colSize=415,this.setItemHeightsFromDOM(a);var d=c(nbColumns);for(var e in a)b(a[e])&&g(a[e],d);return this.applyToDOM(a),d}}}]);