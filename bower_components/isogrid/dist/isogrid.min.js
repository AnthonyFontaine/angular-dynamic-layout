/*
 IsoGrid 2014-12-11 
*/
var isoGridModule=angular.module("isoGrid",["ngAnimate"]).filter("customFilter",["FilterService",function(a){return function(b,c){return c?a.apply(b,c):b}}]).filter("customRanker",["OrderService",function(a){return function(b,c){return c?a.apply(b,c):b}}]).filter("as",function(a){return function(b,c,d){return a(d).assign(c,b)}}).directive("isogrid",["PositionService","$timeout","$window","$q","$animate",function(a,b,c,d){return{restrict:"A",scope:{items:"=items",rankers:"=rankers",filters:"=filters"},template:'<div                           class="isogrid-item-parent"                           ng-repeat="it in items | customFilter: filters | customRanker:rankers | as:this:\'filteredItems\'"                           ng-include="it.template"                           id="isogrid-{{$index}}"                     ></div>',link:function(e,f){var g=function(){var a=d.defer();return b(function(){0===e.toLoad&&a.resolve()}),e.$watch("toLoad",function(b,c){b!==c&&0===e.toLoad&&a.resolve()}),a.promise};e.toLoad=0,e.$on("$includeContentRequested",function(){e.toLoad++}),e.$on("$includeContentLoaded",function(){e.toLoad--}),e.$watch("filteredItems",function(b,c){angular.equals(b,c)||g().then(function(){a.apply(f[0].offsetWidth,e.filteredItems)})},!0);var h=angular.element(c);h.bind("resize",function(){e.$apply(function(){a.apply(f[0].offsetWidth,e.filteredItems)})}),e.externalScope=function(){return e.$parent},e.$on("layout",function(){b(function(){a.apply(f[0].offsetWidth,e.filteredItems)})}),g().then(function(){a.apply(f[0].offsetWidth,e.filteredItems)})}}}]);isoGridModule.factory("FilterService",function(){var a=["=","<",">","<=",">=","!=","in","not in","contains"],b=function(b,c){if("function"==typeof c)return c(b);if(c.length<2)throw"Incorrect statement";var d=c[0],e=c[1],f=c[2];if(-1===a.indexOf(e))throw"Incorrect statement comparator: "+e;if(!b[d])return!1;switch(e){case"=":return b[d]==f;case"<":return b[d]<f;case"<=":return b[d]<=f;case">":return b[d]>f;case">=":return b[d]>=f;case"!=":return b[d]!=f;case"in":return b[d]in f;case"not in":return!(b[d]in f);case"contains":if(!(b[d]instanceof Array))throw"contains statement has to be applied on array";return b[d].indexOf(f)>-1}},c=function(a,c){for(var d in c)if(b(a,c[d]))return!0;return!1},d=function(a,b){for(var d in b)if(!c(a,b[d]))return!1;return!0};return{apply:function(a,b){var c=[];for(var e in a)d(a[e],b)&&c.push(a[e]);return c}}}),isoGridModule.factory("OrderService",function(){return{apply:function(a,b){var c=0,d=function(a,e){var f,g,h=b[c][0],i=b[c][1];if("function"==typeof h)f=h(a),g=h(e);else{if(h in a||h in e){if(!(h in a))return"asc"==i?-1:1;if(!(h in e))return"asc"==i?1:-1}else f=0,g=0;f=a[h],g=e[h]}if(typeof f==typeof g)if("string"==typeof f){var j=f.localeCompare(g);if(1==j)return"asc"==i?1:-1;if(-1==j)return"asc"==i?-1:1}else{if(f>g)return"asc"==i?1:-1;if(g>f)return"asc"==i?-1:1}return++c,b.length>c?d(a,e):0},e=function(a,b){c=0;var e=d(a,b);return e};return b&&a.sort(e),a}}}),isoGridModule.factory("PositionService",["$window","$animate","$timeout",function(a,b,c){function d(a){columns=[];for(var b=0;a>b;++b)columns.push([]);return columns}function e(a){columnsHeights=[];for(var b in a){var c;if(a[b].length){var d=a[b][a[b].length-1];c=d.y+d.height}else c=0;columnsHeights.push(c)}return columnsHeights}function f(a,b,c){var d=a.columnSpan;if(d>b.length)throw Error("Item too large");for(var e=0,f=0,g=0;g<=b.length-d;++g){var h=g,i=g+d,j=Math.max.apply(Math,b.slice(h,i));(0===g||f>j)&&(f=j,e=g)}var k=[];for(g=e;e+d>g;++g)k.push(g);return{columns:k,position:{x:k[0]*c,y:f}}}function g(a,b,c){for(var d in b)a[b[d]].push(c)}function h(a,b,c){var d=e(b),h=f(a,d,c);g(b,h.columns,a),a.x=h.position.x,a.y=h.position.y}function j(a){return angular.element(document.getElementById("isogrid-"+a).children[0])}function k(a){var b;for(i=0;i<a.length;++i)(!b||a[i].width<b)&&(b=a[i].width);return b}function l(a,b){for(i=0;i<a.length;++i)a[i].columnSpan=Math.ceil((a[i].width-2)/b)}function m(a,b){return Math.floor(a/b)}function n(a,c){var d=b.addClass(a,"move-items-animation",{from:{position:"absolute"},to:{left:items[c].x+"px",top:items[c].y+"px"}});return d.then(function(){a.removeClass("move-items-animation"),delete o[c]}),d}var o={};return{setItemDimensionFromDOM:function(b){for(i=0;i<b.length;++i)element=j(i),b[i].height=element[0].offsetHeight+parseInt(a.getComputedStyle(element[0]).marginTop),b[i].width=element[0].offsetWidth+parseInt(a.getComputedStyle(element[0]).marginLeft)},applyToDOM:function(a){var d=function(){for(i=0;i<a.length;++i)element=j(i),o[i]=n(element,i)};if(Object.keys(o).length){for(var e in o)b.cancel(o[e]),delete o[e];c(function(){d()})}else d()},apply:function(a,b){b=angular.copy(b),this.setItemDimensionFromDOM(b),colSize=k(b),l(b,colSize),nbColumns=m(a,colSize);var c=d(nbColumns);for(var e in b)h(b[e],c,colSize);return this.applyToDOM(b),c}}}]);